generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model category {
  id           Int            @id @default(autoincrement())
  categoryName String
  event        event[]
  userinterest userinterest[]
}

model Promotion {
  id        Int      @id @default(autoincrement())
  eventId   Int
  seats     Int
  discount  Float
  validFrom DateTime
  validTo   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  event     event    @relation(fields: [eventId], references: [id])
}

model discountcode {
  id            Int             @id @default(autoincrement())
  code          String          @unique
  amount        Int
  discountPercent Int?             // bisa untuk diskon persen (ex: 10%)
  validFrom     DateTime
  validTo       DateTime
  limit         Int
  codeStatus    code_status
  createdAt     DateTime        @default(now())
  discountusage discountusage[]
}

model discountusage {
  id           Int          @id @default(autoincrement())
  userId       Int
  discountId   Int
  usedAt       DateTime     @default(now())
  discountcode discountcode @relation(fields: [discountId], references: [id])
  user         user         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([discountId])
}

model event {
  id             Int              @id @default(autoincrement())
  userId         Int
  categoryId     Int
  title          String
  description    String
  price          Int
  totalSeats     Int
  statusEvent    status_event
  startTime      DateTime
  endTime        DateTime
  createdAt      DateTime         @default(now())
  ticketType     event_type
  isDeleted      Boolean
  locationId     Int
  images         Image[]
  promotions     Promotion[]
  category       category         @relation(fields: [categoryId], references: [id])
  location       location         @relation(fields: [locationId], references: [id])
  user           user             @relation(fields: [userId], references: [id])
  eventinterest  eventinterest[]
  eventstatistic eventstatistic[]
  filter         filter[]
  historyuser    historyuser[]
  labelevent     labelevent[]
  seat           seat[]
  testimonial    testimonial[]
  ticket         ticket[]

  @@index([userId])
  @@index([categoryId])
  @@index([locationId])
}

model eventinterest {
  id             Int          @id @default(autoincrement())
  userInterestId Int
  eventId        Int
  event          event        @relation(fields: [eventId], references: [id])
  userinterest   userinterest @relation(fields: [userInterestId], references: [id])

  @@index([userInterestId])
  @@index([eventId])
}

model eventstatistic {
  id               Int      @id @default(autoincrement())
  eventId          Int
  totalAttendance  Int
  totalTicketsSold Int
  totalRevenue     Int
  createdAt        DateTime @default(now())
  event            event    @relation(fields: [eventId], references: [id])

  @@index([eventId])
}

model filter {
  id         Int    @id @default(autoincrement())
  eventId    Int
  searchName String
  event      event  @relation(fields: [eventId], references: [id])

  @@index([eventId])
}

model historyuser {
  id      Int   @id @default(autoincrement())
  eventId Int
  userId  Int
  event   event @relation(fields: [eventId], references: [id])
  user    user  @relation(fields: [userId], references: [id])

  @@index([eventId])
  @@index([userId])
}

model label {
  id         Int          @id @default(autoincrement())
  labelName  String
  labelevent labelevent[]
}

model labelevent {
  id      Int   @id @default(autoincrement())
  labelId Int
  eventId Int
  event   event @relation(fields: [eventId], references: [id])
  label   label @relation(fields: [labelId], references: [id])

  @@index([labelId])
  @@index([eventId])
}

model location {
  id           Int           @id @default(autoincrement())
  locationName String
  event        event[]
  userprofile  userprofile[]
}

model seat {
  id             Int      @id @default(autoincrement())
  eventId        Int
  totalSeats     Int
  availableSeats Int
  createdAt      DateTime @default(now())
  event          event    @relation(fields: [eventId], references: [id])

  @@index([eventId])
}

model testimonial {
  id                Int      @id @default(autoincrement())
  userId            Int
  eventId           Int
  reviewDescription String
  rating            Int
  createdAt         DateTime @default(now())
  event             event    @relation(fields: [eventId], references: [id])
  user              user     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([eventId])
}

model ticket {
  id              Int         @id @default(autoincrement())
  eventId         Int
  userId          Int
  qty             Int
  total           Int
  status          paid_status
  transactionDate DateTime    @default(now())
  event           event       @relation(fields: [eventId], references: [id])
  user            user        @relation(fields: [userId], references: [id])

  @@index([eventId])
  @@index([userId])
} 

model user {
  id               Int              @id @default(autoincrement())
  identificationId String
  email            String           @unique
  password         String
  referralCode     String
  referredBy       Int?
  points           Int              @default(0)
  role             role
  tryCount         Int              @default(0)
  isBlocked        Boolean          @default(false)
  isDeleted        Boolean          @default(false)
  createdAt        DateTime         @default(now())

  // Relations
  balance          Float         @default(0)
  discountusage    discountusage[]
  event            event[]
  historyuser      historyuser[]
  point            point[]
  testimonial      testimonial[]
  ticket           ticket[]
  userinterest     userinterest[]
  userprofile      userprofile[]
 balanceHistory   balanceHistory[]

  // Referral system (self relation)
  user             user?            @relation("userTouser", fields: [referredBy], references: [id])
  other_user       user[]           @relation("userTouser")

  @@index([referredBy])
}

model balanceHistory {
  id          Int      @id @default(autoincrement())
  userId      Int
  type        String   // 'credit' | 'debit'
  amount      Float
  description String?
  createdAt   DateTime @default(now())

  user        user     @relation(fields: [userId], references: [id])

  @@index([userId])
}


model userinterest {
  id            Int              @id @default(autoincrement())
  userId        Int
  categoryId    Int

  eventinterest eventinterest[]
  category      category         @relation(fields: [categoryId], references: [id])
  user          user             @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([categoryId])
}

model userprofile {
  id          Int       @id @default(autoincrement())
  userId      Int
  firstName   String?
  lastName    String?
  gender      gender?
  dateOfBirth DateTime?
  image       String?
  address     String?
  phoneNumber String?
  isAdded     Boolean?  @default(false)
  locationId  Int
  location    location  @relation(fields: [locationId], references: [id])
  user        user      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([locationId])
}

model point {
  id        Int      @id @default(autoincrement())
  userId    Int
  amount    Int 
  description String?
  validFrom DateTime
  validTo   DateTime
  expiredAt   DateTime
  createdAt DateTime @default(now())
  user      user     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model BlacklistToken {
  id        Int      @id @default(autoincrement())
  token     String
  createdAt DateTime @default(now())
}

model Image {
  id      Int    @id @default(autoincrement())
  path    String
  eventId Int
  event   event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
}

enum paid_status {
  PAID
  UNPAID
}

enum role {
  USER
  ADMIN
}

enum status_event {
  AVAILABLE
  SOLD_OUT
  ENDED
}

enum event_type {
  PAID
  FREE
}

enum code_status {
  USED
  AVAILABLE
    EXPIRED
}

enum gender {
  MALE
  FEMALE
}
